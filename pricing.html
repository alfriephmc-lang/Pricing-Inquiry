<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pricing Inquiry</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --corp-green:#007941;
  --corp-light:#10b981;
  --glass-bg:rgba(255,255,255,0.08);
  --glass-border:rgba(255,255,255,0.2);
}
body{
  margin:0;overflow:hidden;
  background:radial-gradient(circle,#064e3b,#022c22);
  font-family:system-ui;
  display:flex;justify-content:center;align-items:center;
  min-height:100vh;
}
.glass-card{
  width:95%;max-width:900px;
  background:var(--glass-bg);
  backdrop-filter:blur(20px);
  border:1px solid var(--glass-border);
  border-radius:2.5rem;
  padding:2rem;
  box-shadow:0 25px 50px -12px rgba(0,0,0,.5);
}
input{
  background:rgba(0,0,0,.25)!important;
  border:1px solid rgba(255,255,255,.1)!important;
  color:white!important;
}
input:focus{
  border-color:var(--corp-light)!important;
  box-shadow:0 0 10px rgba(16,185,129,.4)!important;
}
</style>
</head>

<body>

<div class="glass-card">

<div class="flex justify-between items-center mb-6">
  <div class="flex items-center gap-3">
    <img src="https://i.imgur.com/VbZKWAf.png" class="h-10">
    <div>
      <h2 class="text-white font-bold">Pricing Inquiry</h2>
      <p class="text-emerald-400 text-[10px] uppercase tracking-widest">Hospital Database</p>
    </div>
  </div>
  <button onclick="logout()" class="text-xs bg-red-500/80 hover:bg-red-500 px-3 py-2 rounded-lg text-white">
    Logout
  </button>
</div>

<input id="search" placeholder="Search item code or description (e.g. Maternity or EEG)..."
class="w-full px-4 py-3 rounded-xl mb-5 text-sm">

<div class="overflow-auto max-h-[60vh]">
<table class="w-full text-white text-sm">
<thead>
<tr class="text-emerald-400 border-b border-white/10 text-left">
  <th class="py-2 px-2">Item Code</th>
  <th class="px-2">Description</th>
  <th class="px-2">Price</th>
  <th class="px-2">Remarks</th>
</tr>
</thead>
<tbody id="table-body">
  <tr><td colspan="4" class="text-center py-10 text-gray-400 italic">Type to search the database...</td></tr>
</tbody>
</table>
</div>

</div>

<script>
let supabaseClient;

function initSupabase() {
  if (!supabaseClient) {
    supabaseClient = window.supabase.createClient(
      'https://yheciygtsimcduzeavlq.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InloZWNpeWd0c2ltY2R1emVhdmxxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MDExMDgsImV4cCI6MjA4NDM3NzEwOH0.jfzpbDv4EX16D7_Ee_yWz2o3L_X7JWilKmefhjclguc'
    );
  }
  return supabaseClient;
}

const client = initSupabase();

function render(rows) {
  const body = document.getElementById('table-body');
  
  if (!rows || rows.length === 0) {
    body.innerHTML = '<tr><td colspan="4" class="text-center py-10 text-gray-400">No matching items found</td></tr>';
    return;
  }

  body.innerHTML = rows.map(r => `
    <tr class="border-b border-white/5 hover:bg-white/5 transition-colors">
      <td class="py-3 px-2 font-mono text-emerald-300">${r.item_code || '—'}</td>
      <td class="px-2">${r.item_description || 'No Description'}</td>
      <td class="px-2">₱${r.price ? Number(String(r.price).replace(/,/g, '')).toLocaleString(undefined, {minimumFractionDigits: 2}) : '0.00'}</td>
      <td class="px-2 text-gray-400 text-[11px] leading-tight">${r.remarks || ''}</td>
    </tr>
  `).join('');
}

/* SERVER-SIDE SEARCH FUNCTIONALITY */
document.getElementById('search').addEventListener('input', async (e) => {
  const q = e.target.value.trim();
  const body = document.getElementById('table-body');

  // If input is empty, clear the table
  if (q.length < 2) {
    body.innerHTML = '<tr><td colspan="4" class="text-center py-10 text-gray-400 italic">Type at least 2 characters to search...</td></tr>';
    return;
  }

  // Search directly on the Supabase server
  const { data, error } = await client
    .from('pricing_database')
    .select('*')
    .or(`item_code.ilike.%${q}%,item_description.ilike.%${q}%`)
    .limit(50); // Shows top 50 matches for speed

  if (error) {
    console.error("Search error:", error.message);
    return;
  }

  render(data);
});

/* AUTH & LOGOUT */
async function checkAuth() {
  const { data: { session } } = await client.auth.getSession();
  if (!session) {
    // window.location.href = "index.html";
    console.warn("Not logged in");
  }
}

async function logout() {
  await client.auth.signOut();
  window.location.href = "index.html";
}

checkAuth();
</script>

</body>
</html>
